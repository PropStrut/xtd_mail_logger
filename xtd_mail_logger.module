<?php

/**
 * @file
 * XTD Mail Logger module - Logs successful and failed emails to file.
 */

/**
 * Implements hook_permission().
 */
function xtd_mail_logger_permission() {
  return array(
    'administer xtd mail logger' => array(
      'title' => t('Administer XTD Mail Logger'),
      'description' => t('Configure XTD Mail Logger settings.'),
    ),
    'view xtd mail logs' => array(
      'title' => t('View XTD Mail Logs'),
      'description' => t('View XTD Mail Logger logs.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function xtd_mail_logger_menu() {
  $items = array();

  $items['admin/config/development/xtd-mail-logger'] = array(
    'title' => 'XTD Mail Logger',
    'description' => 'Configure XTD Mail Logger settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('xtd_mail_logger_admin_form'),
    'access arguments' => array('administer xtd mail logger'),
    'file' => 'xtd_mail_logger.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/reports/xtd-mail-logs'] = array(
    'title' => 'XTD Mail Logs',
    'description' => 'View XTD Mail Logger logs.',
    'page callback' => 'xtd_mail_logger_logs_page',
    'access arguments' => array('view xtd mail logs'),
    'file' => 'xtd_mail_logger.pages.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_mail_alter().
 */
function xtd_mail_logger_mail_alter(&$message) {
  // We'll capture the mail sending in hook_drupal_mail_send_alter instead
  // This hook just marks that we want to log this message
  $message['#xtd_mail_logger_enabled'] = TRUE;
}

/**
 * Implements hook_drupal_mail_send_alter().
 */
function xtd_mail_logger_drupal_mail_send_alter(&$mailkey, &$message, $params) {
  // This will be called after the mail is sent, but we need to capture the result differently
}

/**
 * Custom mail system class that wraps the default system.
 */
class XTDMailLoggerSystem extends DefaultMailSystem {
  
  public function mail(array $message) {
    // Clear any previous errors
    error_clear_last();
    
    // Capture current error handler to restore later
    $old_error_handler = set_error_handler(function($errno, $errstr, $errfile, $errline) {
      // Store error info in the message array for our logger
      global $xtd_mail_last_error;
      $xtd_mail_last_error = array(
        'errno' => $errno,
        'errstr' => $errstr,
        'errfile' => $errfile,
        'errline' => $errline,
        'timestamp' => time(),
      );
      return FALSE; // Let PHP handle the error normally too
    });
    
    try {
      // Send using parent class
      $result = parent::mail($message);
      
      // If sending failed, try to get more specific error info
      if (!$result) {
        global $xtd_mail_last_error;
        if (isset($xtd_mail_last_error)) {
          $message['#xtd_error'] = $xtd_mail_last_error['errstr'];
        }
      }
      
    } catch (Exception $e) {
      $result = FALSE;
      $message['#xtd_error'] = $e->getMessage();
    }
    
    // Restore original error handler
    if ($old_error_handler) {
      set_error_handler($old_error_handler);
    } else {
      restore_error_handler();
    }
    
    // Log the result
    xtd_mail_logger_log_email($message, $result);
    
    return $result;
  }
}

/**
 * Implements hook_init().
 */
function xtd_mail_logger_init() {
  // Override the default mail system to use our logger
  $mail_system = variable_get('mail_system', array('default-system' => 'DefaultMailSystem'));
  
  // Only override if not already set to avoid conflicts
  if (!isset($mail_system['default-system']) || $mail_system['default-system'] == 'DefaultMailSystem') {
    $mail_system['default-system'] = 'XTDMailLoggerSystem';
    variable_set('mail_system', $mail_system);
  }
}

/**
 * Log email to file only.
 */
function xtd_mail_logger_log_email($message, $result) {
  // Only log to file now
  if (!variable_get('xtd_mail_logger_file', TRUE)) {
    return;
  }
  
  $status = $result ? 'PASS' : 'FAIL';
  $failure_reason = '';
  
  if (!$result) {
    // Try multiple methods to get failure reason
    $failure_reason = 'Mail send failed';
    
    // Method 1: Check for recent PHP errors
    $error = error_get_last();
    if ($error && (
        stripos($error['message'], 'mail') !== FALSE || 
        stripos($error['message'], 'smtp') !== FALSE ||
        stripos($error['message'], 'sendmail') !== FALSE ||
        time() - $error['timestamp'] < 5 // Recent error within 5 seconds
    )) {
      $failure_reason = $error['message'];
    }
    
    // Method 2: Check if we have additional error info in the message array
    if (isset($message['#xtd_error'])) {
      $failure_reason = $message['#xtd_error'];
    }
    
    // Method 3: Check common mail configuration issues
    if ($failure_reason == 'Mail send failed') {
      $mail_system = variable_get('mail_system', array());
      if (empty($mail_system) || !isset($mail_system['default-system'])) {
        $failure_reason = 'Mail system not configured';
      } else {
        // Try to give more specific reasons based on common issues
        if (!function_exists('mail')) {
          $failure_reason = 'PHP mail() function not available';
        } elseif (empty($message['to'])) {
          $failure_reason = 'No recipient specified';
        } elseif (empty($message['from'])) {
          $failure_reason = 'No sender specified';
        } else {
          $failure_reason = 'Mail send failed - check server mail configuration';
        }
      }
    }
  }
  
  // Get module/key information for tracking email source
  $module_key = 'unknown';
  if (isset($message['module']) && isset($message['key'])) {
    $module_key = $message['module'] . '/' . $message['key'];
  }
  
  $log_data = array(
    'timestamp' => REQUEST_TIME,
    'status' => $status,
    'failure_reason' => $failure_reason,
    'subject' => isset($message['subject']) ? $message['subject'] : '',
    'from_email' => isset($message['from']) ? $message['from'] : '',
    'to_email' => isset($message['to']) ? $message['to'] : '',
    'module_key' => $module_key,
  );
  
  // Log to file
  xtd_mail_logger_write_to_file($log_data);
}

/**
 * Write log entry to file.
 */
function xtd_mail_logger_write_to_file($log_data) {
  $log_dir = 'sites/default/files';
  $log_file = $log_dir . '/xtd_email_logger.log';
  
  // Ensure directory exists
  if (!file_exists($log_dir)) {
    mkdir($log_dir, 0755, TRUE);
  }
  
  $timestamp = date('Y-m-d H:i:s', $log_data['timestamp']);
  $log_line = sprintf(
    "[%s] %s | Module: %s | Subject: %s | From: %s | To: %s | Reason: %s\n",
    $timestamp,
    $log_data['status'],
    $log_data['module_key'],
    $log_data['subject'],
    $log_data['from_email'],
    $log_data['to_email'],
    $log_data['failure_reason']
  );
  
  file_put_contents($log_file, $log_line, FILE_APPEND | LOCK_EX);
}

/**
 * Implements hook_cron().
 */
function xtd_mail_logger_cron() {
  $retention_days = variable_get('xtd_mail_logger_retention_days', 3);
  
  // Skip cleanup if retention is set to 0 (disabled)
  if ($retention_days <= 0) {
    return;
  }
  
  // Clean up old file logs
  if (variable_get('xtd_mail_logger_file', TRUE)) {
    xtd_mail_logger_cleanup_file_logs($retention_days);
  }
}

/**
 * Clean up old file logs.
 */
function xtd_mail_logger_cleanup_file_logs($retention_days = NULL) {
  if ($retention_days === NULL) {
    $retention_days = variable_get('xtd_mail_logger_retention_days', 3);
  }
  
  // Skip cleanup if retention is disabled
  if ($retention_days <= 0) {
    return;
  }
  
  $log_file = 'sites/default/files/xtd_email_logger.log';
  
  if (!file_exists($log_file)) {
    return;
  }
  
  $cutoff = REQUEST_TIME - ($retention_days * 24 * 60 * 60);
  $lines = file($log_file, FILE_IGNORE_NEW_LINES);
  $new_lines = array();
  $removed_count = 0;
  
  foreach ($lines as $line) {
    if (preg_match('/^\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/', $line, $matches)) {
      $log_timestamp = strtotime($matches[1]);
      if ($log_timestamp >= $cutoff) {
        $new_lines[] = $line;
      } else {
        $removed_count++;
      }
    } else {
      // Keep lines that don't match the expected format
      $new_lines[] = $line;
    }
  }
  
  if ($removed_count > 0) {
    file_put_contents($log_file, implode("\n", $new_lines) . "\n");
    watchdog('xtd_mail_logger', 'Cleaned up @count old file log entries (older than @days days).', 
      array('@count' => $removed_count, '@days' => $retention_days), WATCHDOG_INFO);
  }
}

/**
 * Clear all logs.
 */
function xtd_mail_logger_clear_all_logs() {
  // Clear file logs
  $log_file = 'sites/default/files/xtd_email_logger.log';
  if (file_exists($log_file)) {
    unlink($log_file);
  }
  
  drupal_set_message(t('All XTD Mail Logger logs have been cleared.'));
}
